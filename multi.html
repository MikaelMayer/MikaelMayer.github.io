<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="version" content="1.1.4" />
  <title>Multiplayer HTML Game v1.1.4</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-bottom: 20px;
    }
    input[type="text"],
    input[type="password"],
    textarea,
    button {
      width: 100%;
      max-width: 400px;
      margin: 5px 0;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .hidden {
      display: none !important;
    }
    #playersList {
      margin: 10px 0;
      width: 100%;
      max-width: 400px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-sizing: border-box;
    }
    #playersList p {
      margin: 5px 0;
    }
    #chatBox {
      width: 100%;
      max-width: 400px;
      height: 150px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-sizing: border-box;
      margin-bottom: 5px;
    }
    #joinCreateContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
    }
    #hostStartedOptions button {
      margin-top: 10px;
    }
    #codeEditor {
      margin-top: 10px;
      height: 100px;
    }
  </style>
</head>
<body>
  <h1>Multiplayer HTML Game v1.1.4</h1>

  <!-- 1: Enter Name -->
  <div id="enterNameContainer">
    <input type="text" id="playerName" placeholder="Your Name" />
    <button id="saveNameBtn">Save Name</button>
  </div>

  <!-- 2: Join or Create Game -->
  <div id="joinCreateContainer" class="hidden">
    <input type="text" id="gameIdInput" placeholder="Enter Game ID to join" maxlength="8" />
    <button id="joinCreateBtn">Create Game</button>
  </div>

  <!-- 3: Creator token prompt (if needed) -->
  <div id="tokenContainer" class="hidden">
    <input type="password" id="creatorTokenInput" placeholder="Enter Creator Token" />
    <button id="saveTokenBtn">Save Token</button>
  </div>

  <!-- 4: Game Lobby -->
  <div id="lobbyContainer" class="hidden">
    <p>
      <strong>Game ID:</strong> <span id="gameIdDisplay"></span>
      <button id="copyLinkBtn">Copy Link</button>
      <span id="copyNotice" style="color:green"></span>
    </p>
    <div id="playersList"><h3>Players:</h3></div>
    <div id="chatBox"></div>
    <input type="text" id="chatInput" placeholder="Type your message..." />

    <!-- Shared code editor -->
    <textarea id="codeEditor" placeholder="Paste or edit HTML/JS game code here..."></textarea>

    <!-- Copy LLM Info button (behavior changes based on whether game started) -->
    <button id="copyLLMBtn" class="hidden">Copy LLM Info</button>

    <!-- Host options before game start -->
    <div id="hostOptions" class="hidden">
      <button id="startGameBtn">Start Game</button>
    </div>

    <!-- Host options after game started -->
    <div id="hostStartedOptions" class="hidden">
      <button id="returnToGameBtn">Return to Game</button>
      <button id="updateCodeBtn">Update Code for Players</button>
      <button id="resetGameBtn">Reset Game (End Current Session)</button>
    </div>

    <p id="waitingMsg" class="hidden">Waiting for the host to start the game...</p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // --- Config Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAAcMZ-dvevYe7IuPSkkdW1ZITQJo8vHqY",
      authDomain: "htmls-f4326.firebaseapp.com",
      databaseURL: "https://htmls-f4326-default-rtdb.firebaseio.com",
      projectId: "htmls-f4326",
      storageBucket: "htmls-f4326.appspot.com",
      messagingSenderId: "1091418638117",
      appId: "1:1091418638117:web:22a03ada0c812b82177ccc",
      measurementId: "G-NF8DJEP777"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Utilitaires d’erreur ---
    function showError(err, path) {
      const fullMsg = `Firebase Error on "${path}": ${err.message}`;
      console.error(fullMsg);
      alert(fullMsg);
    }

    // --- Lecture initiale des paramètres / cookies ---
    const urlParams = new URLSearchParams(location.search);
    let playerName = null;
    let gameId = urlParams.get("game") || null;
    let creatorToken = urlParams.get("token") || getCookie("token");
    let isHost = false;

    // Récupère la valeur d’un cookie
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }
    function setCookie(name, value) {
      document.cookie = `${name}=${value}; path=/`;
    }

    // Génère un ID de jeu de 8 caractères
    function generateGameId() {
      const chars = "ABCDEFGHJKLMNPRSTUVWXYZ23456789";
      let id = "";
      for (let i = 0; i < 8; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return id;
    }

    // Met à jour l’URL sans recharger la page
    function updateURL(params) {
      const url = new URL(location.href);
      Object.keys(params).forEach(key => {
        if (params[key] !== null) url.searchParams.set(key, params[key]);
        else url.searchParams.delete(key);
      });
      history.replaceState(null, "", url.toString());
    }

    // --- Ajoute un joueur sous /games/<gameId>/players/<playerName> ---
    function addPlayer() {
      if (!gameId || !playerName) return;
      const playersPath = `games/${gameId}/players/${playerName}`;
      db.ref(playersPath)
        .set(playerName)
        .catch(err => showError(err, playersPath));
      db.ref(playersPath)
        .onDisconnect()
        .remove()
        .catch(err => showError(err, playersPath + " (onDisconnect)"));
    }

    // --- Installe le chat sous /games/<gameId>/chat ---
    function setupChat() {
      if (!gameId) return;
      const chatPath = `games/${gameId}/chat`;
      const chatRef = db.ref(chatPath);
      chatRef.off("child_added");
      chatRef.on("child_added", snap => {
        const { name, text } = snap.val();
        const p = document.createElement("p");
        p.innerHTML = `<strong>${name}:</strong> ${text}`;
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
      }, err => showError(err, chatPath));

      chatInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && chatInput.value.trim()) {
          e.preventDefault();
          const message = chatInput.value.trim();
          chatRef.push({ name: playerName, text: message })
            .catch(err => showError(err, chatPath + " (push)"));
          chatInput.value = "";
        }
      });
    }

    // --- Crée la racine si token connu, sinon prompt ---
    function ensureRootExistsThen(callback) {
      const rootPath = `games/${gameId}`;
      db.ref(rootPath).once("value")
        .then(snap => {
          if (snap.exists()) {
            callback();
          } else {
            if (creatorToken) {
              db.ref(rootPath)
                .set({ token: creatorToken, started: false })
                .then(callback)
                .catch(err => showError(err, rootPath + " (auto-create)"));
            } else {
              showTokenPromptAsJoiner();
            }
          }
        })
        .catch(err => showError(err, rootPath + " (existence check)"));
    }

    // --- Prompt token pour créer la partie (host) ---
    function showTokenPrompt() {
      tokenContainer.classList.remove("hidden");
      saveTokenBtn.onclick = () => {
        if (!playerName) {
          alert("Please save your name first.");
          return;
        }
        const tokenVal = creatorTokenInput.value.trim();
        if (!tokenVal) {
          alert("Please enter a token.");
          return;
        }
        creatorToken = tokenVal;
        setCookie("token", creatorToken);
        gameId = generateGameId();
        const rootPath = `games/${gameId}`;
        db.ref(rootPath)
          .set({ token: creatorToken, started: false })
          .then(() => {
            isHost = true;
            addPlayer();
            updateURL({ token: creatorToken, game: gameId });
            tokenContainer.classList.add("hidden");
            joinCreateContainer.classList.add("hidden");
            showLobby();
          })
          .catch(err => showError(err, rootPath));
      };
    }

    // --- Prompt token pour rejoindre (si la partie n'existe pas) ---
    function showTokenPromptAsJoiner() {
      tokenContainer.classList.remove("hidden");
      saveTokenBtn.onclick = () => {
        if (!playerName) {
          alert("Please save your name first.");
          return;
        }
        const tokenVal = creatorTokenInput.value.trim();
        if (!tokenVal) {
          alert("Please enter a token.");
          return;
        }
        creatorToken = tokenVal;
        setCookie("token", creatorToken);
        const rootPath = `games/${gameId}`;
        db.ref(rootPath)
          .set({ token: creatorToken, started: false })
          .then(() => {
            isHost = true;
            addPlayer();
            updateURL({ token: creatorToken, game: gameId });
            tokenContainer.classList.add("hidden");
            joinCreateContainer.classList.add("hidden");
            showLobby();
          })
          .catch(err => showError(err, rootPath));
      };
    }

    // --- Affiche ou cache les vues selon l’état de la partie ---
    function showJoinCreate() {
      if (gameId) {
        joinCreateContainer.classList.add("hidden");
        tokenContainer.classList.add("hidden");
        ensureRootExistsThen(() => {
          db.ref(`games/${gameId}/started`).once("value")
            .then(snap => {
              if (snap.val() === true) {
                checkHostViewOrClient();
              } else {
                addPlayer();
                showLobby();
              }
            })
            .catch(err => showError(err, `games/${gameId}/started (once)`));
        });
        return;
      }

      joinCreateContainer.classList.remove("hidden");
      gameIdInput.addEventListener("input", () => {
        joinCreateBtn.textContent = gameIdInput.value.trim() ? "Join Game" : "Create Game";
      });
      joinCreateBtn.onclick = () => {
        if (!playerName) {
          alert("Please save your name first.");
          return;
        }
        const enteredId = gameIdInput.value.trim().toUpperCase();
        if (enteredId) {
          gameId = enteredId;
          updateURL({ game: gameId });
          joinCreateContainer.classList.add("hidden");
          ensureRootExistsThen(() => {
            db.ref(`games/${gameId}/started`).once("value")
              .then(snap => {
                if (snap.val() === true) {
                  checkHostViewOrClient();
                } else {
                  addPlayer();
                  showLobby();
                }
              })
              .catch(err => showError(err, `games/${gameId}/started (once)`));
          });
        } else {
          showTokenPrompt();
        }
      };
    }

    // --- Détermine si on affiche l’interface Host (avec le jeu démarré) ou Client ---
    function checkHostViewOrClient() {
      db.ref(`games/${gameId}/token`).once("value")
        .then(snap => {
          const tokenInDb = snap.val();
          if (creatorToken === tokenInDb) {
            isHost = true;
            showHostStartedOptions();
          } else {
            isHost = false;
            db.ref(`games/${gameId}/code`).once("value")
              .then(snapCode => {
                if (snapCode.exists()) {
                  launchGame(snapCode.val());
                }
              })
              .catch(err => showError(err, `games/${gameId}/code (once)`));
          }
        })
        .catch(err => showError(err, `games/${gameId}/token (once)`));
    }

    // --- Affichage de la salle (lobby) pour joueurs non‐host ou host avant démarrage ---
    function showLobby() {
      joinCreateContainer.classList.add("hidden");
      tokenContainer.classList.add("hidden");
      lobbyContainer.classList.remove("hidden");

      gameIdDisplay.textContent = gameId;
      copyLinkBtn.onclick = () => {
        const link = `${location.origin}${location.pathname}?game=${gameId}`;
        navigator.clipboard.writeText(link).then(() => {
          copyNotice.textContent = "Link copied!";
          setTimeout(() => (copyNotice.textContent = ""), 2000);
        });
      };

      const playersPath = `games/${gameId}/players`;
      const playersRef = db.ref(playersPath);
      playersRef.off("value");
      playersRef.on("value", snap => {
        const val = snap.val() || {};
        playersList.innerHTML =
          "<h3>Players:</h3>" +
          Object.values(val)
            .map(p => `<p>${p}</p>`)
            .join("");
      }, err => showError(err, playersPath));

      setupChat();

      const startedRef = db.ref(`games/${gameId}/started`);
      startedRef.off("value");
      startedRef.on("value", snap => {
        if (snap.val() === true) {
          startedRef.off();
          checkHostViewOrClient();
        }
      }, err => showError(err, `games/${gameId}/started (on)`));

      if (isHost) {
        hostOptions.classList.remove("hidden");
        hostStartedOptions.classList.add("hidden");
        waitingMsg.classList.add("hidden");
        copyLLMBtn.classList.remove("hidden");
        copyLLMBtn.textContent = "Copy LLM Info (Initial)";
      } else {
        waitingMsg.classList.remove("hidden");
        copyLLMBtn.classList.add("hidden");
      }
    }

    // --- Affichage des options Host après démarrage ---
    function showHostStartedOptions() {
      lobbyContainer.classList.remove("hidden");
      hostOptions.classList.add("hidden");
      hostStartedOptions.classList.remove("hidden");
      waitingMsg.classList.add("hidden");
      document.getElementById("playersList").style.display = "none";
      document.getElementById("chatBox").style.display = "none";
      chatInput.style.display = "none";
      copyLinkBtn.style.display = "none";

      // Make sure the textarea is still visible for edits
      codeEditor.classList.remove("hidden");
      copyLLMBtn.classList.remove("hidden");
      copyLLMBtn.textContent = "Copy LLM Info (Update)";

      // Return to Game
      returnToGameBtn.onclick = () => {
        db.ref(`games/${gameId}/code`).once("value")
          .then(snap => {
            if (snap.exists()) {
              launchGame(snap.val());
            }
          })
          .catch(err => showError(err, `games/${gameId}/code (once)`));
      };

      // Update Code for Players
      updateCodeBtn.onclick = () => {
        const newCode = codeEditor.value;
        db.ref(`games/${gameId}/code`)
          .set(newCode)
          .then(() => {
            alert("Code updated. Players should reload the page to see new version.");
          })
          .catch(err => showError(err, `games/${gameId}/code`));
      };

      // Reset Game (End Current Session)
      resetGameBtn.onclick = () => {
        db.ref(`games/${gameId}/started`)
          .set(false)
          .then(() => {
            alert("Game reset. Players must reload to return to lobby.");
            hostStartedOptions.classList.add("hidden");
            hostOptions.classList.remove("hidden");
            document.getElementById("playersList").style.display = "block";
            document.getElementById("chatBox").style.display = "block";
            chatInput.style.display = "block";
            copyLinkBtn.style.display = "inline-block";
            copyLLMBtn.classList.add("hidden");
          })
          .catch(err => showError(err, `games/${gameId}/started`));
      };
    }

    // --- Start Game (host) ---
    startGameBtn.onclick = () => {
      const code = codeEditor.value;
      const updates = {};
      updates[`games/${gameId}/code`] = code;
      updates[`games/${gameId}/started`] = true;
      db.ref().update(updates)
        .catch(err => showError(err, `games/${gameId}`));
    };

    // --- Copy LLM Info (single button) ---
    copyLLMBtn.onclick = () => {
      db.ref(`games/${gameId}/started`).once("value")
        .then(snapStarted => {
          const started = snapStarted.val();
          let prompt;
          if (!started) {
            prompt = `
You are building a multiplayer browser game in a single HTML file.

Requirements:
- Each player has a unique name passed via URL parameter 'name'.
- The game room is identified by 'game' parameter in the URL.
- The host passes a 'token' parameter in the URL to create the room.
- Use Firebase Realtime Database at path 'games/${gameId}' to synchronize:
  - players list at '/players'
  - chat at '/chat'
  - game code at '/code'
  - a boolean '/started' to indicate if game is running
- Host can update code mid‐game (clients reload manually).
- Host can reset game (set started=false).
- Once started==true, clients automatically load code via document.write.

Write a complete HTML/JS implementation following these rules.
            `.trim();
          } else {
            prompt = `
You are building a multiplayer browser game in a single HTML file. This is the **update** prompt:

Requirements:
- The base game code already exists under '/games/${gameId}/code'.
- The host wants to push a new version of the code without restarting the session.
- Ensure that when clients reload manually, they load the newest version.
- All existing players must remain connected under '/games/${gameId}/players'.
- Maintain chat under '/games/${gameId}/chat'.
- Maintain the ability to still start or reset via '/games/${gameId}/started'.

Write a complete HTML/JS diff or update that applies this new version while preserving the lobby architecture.
            `.trim();
          }
          navigator.clipboard.writeText(prompt).then(() => alert("LLM prompt copied!"));
        })
        .catch(err => showError(err, `games/${gameId}/started (once for copy)`));
    };

    // --- Launch the code of the game ---
    function launchGame(code) {
      document.open();
      document.write(code);
      document.close();
    }

    // --- Initialization on page load ---
    window.onload = () => {
      const nameParam = urlParams.get("name");
      if (nameParam) {
        playerName = nameParam;
        setCookie("name", playerName);
        document.getElementById("playerName").value = playerName;
        enterNameContainer.classList.add("hidden");
        showJoinCreate();
      } else {
        const fromCookie = getCookie("name");
        if (fromCookie) {
          playerName = fromCookie;
          document.getElementById("playerName").value = playerName;
        }
      }

      if (gameId && playerName) {
        enterNameContainer.classList.add("hidden");
        joinCreateContainer.classList.add("hidden");
        tokenContainer.classList.add("hidden");
        ensureRootExistsThen(() => {
          db.ref(`games/${gameId}/started`).once("value")
            .then(snap => {
              if (snap.val() === true) {
                checkHostViewOrClient();
              } else {
                addPlayer();
                showLobby();
              }
            })
            .catch(err => showError(err, `games/${gameId}/started (once)`));  
        });
      }
    };

    // --- Save Name button ---
    document.getElementById("saveNameBtn").onclick = () => {
      const nameVal = document.getElementById("playerName").value.trim();
      if (!nameVal) {
        alert("Please enter your name.");
        return;
      }
      playerName = nameVal;
      setCookie("name", playerName);
      updateURL({ name: playerName });
      enterNameContainer.classList.add("hidden");
      showJoinCreate();
    };
  </script>
</body>
</html>

