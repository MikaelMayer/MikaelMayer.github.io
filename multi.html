<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="version" content="1.0.6" />
  <title>Multiplayer HTML Game v1.0.6</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-bottom: 20px;
    }
    input[type="text"],
    input[type="password"],
    textarea,
    button {
      width: 100%;
      max-width: 400px;
      margin: 5px 0;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .hidden {
      display: none !important;
    }
    #playersList {
      margin: 10px 0;
      width: 100%;
      max-width: 400px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-sizing: border-box;
    }
    #playersList p {
      margin: 5px 0;
    }
    #chatBox {
      width: 100%;
      max-width: 400px;
      height: 150px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-sizing: border-box;
      margin-bottom: 5px;
    }
    #joinCreateContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h1>Multiplayer HTML Game v1.0.6 (with Debug)</h1>

  <!-- 1: Enter Name -->
  <div id="enterNameContainer">
    <input type="text" id="playerName" placeholder="Your Name" />
    <button id="saveNameBtn">Save Name</button>
  </div>

  <!-- 2: Join or Create Game -->
  <div id="joinCreateContainer" class="hidden">
    <input type="text" id="gameIdInput" placeholder="Enter Game ID to join" maxlength="8" />
    <button id="joinCreateBtn">Create Game</button>
  </div>

  <!-- 3: Creator token prompt (if needed) -->
  <div id="tokenContainer" class="hidden">
    <input type="password" id="creatorTokenInput" placeholder="Enter Creator Token" />
    <button id="saveTokenBtn">Save Token</button>
  </div>

  <!-- 4: Game Lobby -->
  <div id="lobbyContainer" class="hidden">
    <p>
      <strong>Game ID:</strong> <span id="gameIdDisplay"></span>
      <button id="copyLinkBtn">Copy Link</button>
      <span id="copyNotice" style="color:green"></span>
    </p>
    <div id="playersList"><h3>Players:</h3></div>
    <div id="chatBox"></div>
    <input type="text" id="chatInput" placeholder="Type your message..." />

    <!-- Host only -->
    <div id="hostOptions" class="hidden">
      <textarea id="codeEditor" placeholder="Paste HTML/JS game code here..."></textarea>
      <button id="testGameBtn">Test Game</button>
      <button id="launchGameBtn">Launch Game</button>
      <button id="copyLLMBtn">Copy LLM Info</button>
    </div>

    <p id="waitingMsg" class="hidden">Waiting for the host to start the game...</p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // --- Config Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAAcMZ-dvevYe7IuPSkkdW1ZITQJo8vHqY",
      authDomain: "htmls-f4326.firebaseapp.com",
      databaseURL: "https://htmls-f4326-default-rtdb.firebaseio.com",
      projectId: "htmls-f4326",
      storageBucket: "htmls-f4326.appspot.com",
      messagingSenderId: "1091418638117",
      appId: "1:1091418638117:web:22a03ada0c812b82177ccc",
      measurementId: "G-NF8DJEP777"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Utilitaires de débogage ---
    function debug(msg) {
      console.log("[DEBUG] " + msg);
      alert("[DEBUG] " + msg);
    }
    function showError(err, path) {
      const fullMsg = `Firebase Error on "${path}": ${err.message}`;
      console.error(fullMsg);
      alert(fullMsg);
    }

    // --- Lecture initiale des paramètres / cookies ---
    const urlParams = new URLSearchParams(location.search);
    let playerName = null;
    let gameId = urlParams.get("game") || null;
    let creatorToken = urlParams.get("token") || getCookie("token");
    let isHost = false;

    console.log("Initial URL params: game=", gameId, ", token=", creatorToken, ", name=", urlParams.get("name"));

    // Récupère la valeur d’un cookie
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }
    function setCookie(name, value) {
      document.cookie = `${name}=${value}; path=/`;
    }

    // Fonction pour générer un ID de jeu de 8 caractères
    function generateGameId() {
      const chars = "ABCDEFGHJKLMNPRSTUVWXYZ23456789";
      let id = "";
      for (let i = 0; i < 8; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return id;
    }

    // Met à jour l’URL sans recharger la page
    function updateURL(params) {
      const url = new URL(location.href);
      Object.keys(params).forEach(key => {
        if (params[key] !== null) url.searchParams.set(key, params[key]);
        else url.searchParams.delete(key);
      });
      history.replaceState(null, "", url.toString());
      console.log("URL mise à jour vers:", url.toString());
    }

    // --- Fonction qui ajoute un joueur sous /games/<gameId>/players/<playerName> ---
    function addPlayer() {
      debug(`addPlayer() appelé avec gameId="${gameId}", playerName="${playerName}"`);
      if (!gameId || !playerName) {
        debug("addPlayer annulé : gameId ou playerName manquant");
        return;
      }
      const path = `games/${gameId}/players/${playerName}`;
      debug(`Tentative d’écriture au chemin "${path}" avec valeur "${playerName}"`);
      db.ref(path)
        .set(playerName)
        .then(() => {
          debug(`Succès: joueur "${playerName}" ajouté sous "/games/${gameId}/players"`);
        })
        .catch(err => showError(err, path));

      // Supprimer automatiquement à la déconnexion
      db.ref(path)
        .onDisconnect()
        .remove()
        .catch(err => showError(err, path + " (onDisconnect)"));
    }

    // --- Fonction qui met en place le chat sous /games/<gameId>/chat ---
    function setupChat() {
      debug(`setupChat() appelé pour gameId="${gameId}"`);
      if (!gameId) {
        debug("setupChat annulé : gameId manquant");
        return;
      }
      const chatPath = `games/${gameId}/chat`;
      debug(`Installation du listener sur "${chatPath}"`);
      const chatRef = db.ref(chatPath);

      // À chaque nouveau message ajouté
      chatRef.on("child_added", snap => {
        const { name, text } = snap.val();
        debug(`Nouveau message reçu: { name: "${name}", text: "${text}" }`);
        const p = document.createElement("p");
        p.innerHTML = `<strong>${name}:</strong> ${text}`;
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
      }, err => showError(err, chatPath));

      chatInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && chatInput.value.trim()) {
          e.preventDefault();
          const message = chatInput.value.trim();
          debug(`Envoi d’un nouveau message "${message}" au chemin "${chatPath}"`);
          chatRef
            .push({ name: playerName, text: message })
            .then(() => {
              debug("Message poussé avec succès.");
            })
            .catch(err => showError(err, chatPath + " (push)"));
          chatInput.value = "";
        }
      });
    }

    // --- Quand l’hôte clique sur “Create Game” et entre le token ---
    function showTokenPrompt() {
      debug("showTokenPrompt() appelé");
      tokenContainer.classList.remove("hidden");
      saveTokenBtn.onclick = () => {
        if (!playerName) {
          alert("Please save your name first.");
          return;
        }
        const tokenVal = creatorTokenInput.value.trim();
        if (!tokenVal) {
          alert("Please enter a token.");
          return;
        }
        creatorToken = tokenVal;
        debug(`Token saisi par le host: "${creatorToken}"`);
        setCookie("token", creatorToken);

        // Générer un nouvel ID de jeu
        gameId = generateGameId();
        debug(`Nouvel gameId généré: "${gameId}"`);

        // 1) Écrire d’abord { token } à /games/<gameId>
        const rootPath = `games/${gameId}`;
        debug(`Tentative de création de la partie sous "${rootPath}" avec token`);
        db.ref(rootPath)
          .set({ token: creatorToken })
          .then(() => {
            debug(`✔ Room "${gameId}" créée avec succès (token stocké).`);
            // 2) Ajouter immédiatement le host comme joueur
            addPlayer();
            // 3) Mettre à jour l’URL (seulement game et token)
            updateURL({ token: creatorToken, game: gameId });
            tokenContainer.classList.add("hidden");
            joinCreateContainer.classList.add("hidden");
            isHost = true;
            // 4) Afficher la salle (players, chat, host UI)
            showLobby();
          })
          .catch(err => showError(err, rootPath));
      };
    }

    // --- Affiche ou cache les vues selon l’état de la partie ---
    function showJoinCreate() {
      debug("showJoinCreate() appelé avec gameId=" + gameId);

      // Si gameId déjà présent, on passe directement à la salle
      if (gameId) {
        debug("gameId fourni (“" + gameId + "”) → appel addPlayer() et showLobby()");
        joinCreateContainer.classList.add("hidden");
        tokenContainer.classList.add("hidden");
        addPlayer();
        showLobby();
        return;
      }

      // Sinon, on affiche le formulaire pour taper ou créer
      joinCreateContainer.classList.remove("hidden");
      gameIdInput.addEventListener("input", () => {
        joinCreateBtn.textContent = gameIdInput.value.trim() ? "Join Game" : "Create Game";
      });
      joinCreateBtn.onclick = () => {
        if (!playerName) {
          alert("Please save your name first.");
          return;
        }
        const enteredId = gameIdInput.value.trim().toUpperCase();
        if (enteredId) {
          // Rejoindre une partie existante
          gameId = enteredId;
          debug(`Le joueur "${playerName}" rejoint la partie "${gameId}"`);
          updateURL({ game: gameId });
          joinCreateContainer.classList.add("hidden");
          addPlayer();
          showLobby();
        } else {
          // Créer une nouvelle partie → demander le token
          debug("Aucun gameId entré, on passe à showTokenPrompt()");
          showTokenPrompt();
        }
      };
    }

    // --- Affichage de la salle (lobby) ---
    function showLobby() {
      debug("showLobby() appelé pour gameId=" + gameId + " / playerName=" + playerName);

      // Cacher tous les blocs précédents
      joinCreateContainer.classList.add("hidden");
      tokenContainer.classList.add("hidden");
      lobbyContainer.classList.remove("hidden");

      // Afficher le gameId et configurer “Copy Link”
      gameIdDisplay.textContent = gameId;
      copyLinkBtn.onclick = () => {
        const link = `${location.origin}${location.pathname}?game=${gameId}`;
        debug(`Copie du lien: "${link}"`);
        navigator.clipboard.writeText(link).then(() => {
          copyNotice.textContent = "Link copied!";
          setTimeout(() => (copyNotice.textContent = ""), 2000);
        });
      };

      // LISTE DES JOUEURS
      const playersPath = `games/${gameId}/players`;
      debug(`Installation du listener pour la liste des joueurs sous "${playersPath}"`);
      const playersRef = db.ref(playersPath);

      playersRef.on("value", snap => {
        const val = snap.val() || {};
        debug(`Liste des joueurs mise à jour: ${JSON.stringify(Object.values(val))}`);
        playersList.innerHTML =
          "<h3>Players:</h3>" +
          Object.values(val)
            .map(p => `<p>${p}</p>`)
            .join("");
      }, err => showError(err, playersPath));

      // CHAT
      setupChat();

      // OPTIONS HÔTE vs ATTENTE
      if (isHost) {
        debug("Affichage de l’UI Host");
        hostOptions.classList.remove("hidden");
        waitingMsg.classList.add("hidden");
      } else {
        debug("Affichage du message “Waiting for the host”");
        waitingMsg.classList.remove("hidden");
        // Écoute du code publié par l’hôte
        const codePath = `games/${gameId}/code`;
        debug(`Installation du listener pour le code du jeu sous "${codePath}"`);
        const codeRef = db.ref(codePath);
        codeRef.on(
          "value",
          snap => {
            if (snap.exists()) {
              const code = snap.val();
              debug("Code du jeu reçu depuis Firebase, lancement via document.write()");
              waitingMsg.classList.add("hidden");
              launchGame(code);
            } else {
              debug("Pas encore de code publié sous " + codePath);
            }
          },
          err => showError(err, codePath)
        );
      }
    }

    // --- Test/Launch du code du jeu (host et clients) ---
    testGameBtn.onclick = () => {
      const code = codeEditor.value;
      debug("TestGame: launchGame() appelé (host local)");
      launchGame(code);
    };
    launchGameBtn.onclick = () => {
      const code = codeEditor.value;
      const codePath = `games/${gameId}/code`;
      debug(`Tentative d’écriture du code du jeu sous "${codePath}"`);
      db.ref(codePath)
        .set(code)
        .then(() => {
          debug("Code publié avec succès sous " + codePath);
        })
        .catch(err => showError(err, codePath));
    };

    // --- Copie du prompt LLM (host) ---
    copyLLMBtn.onclick = () => {
      const prompt = `
You are building a multiplayer browser game in a single HTML file.

Requirements:
- Each player has a unique name passed via URL parameter 'name'.
- The game room is identified by 'game' parameter in the URL.
- The host passes a 'token' parameter in the URL to create the room.
- Use Firebase Realtime Database at path 'games/${gameId}' to synchronize:
  - players list at '/players'
  - chat at '/chat'
  - game code at '/code'
- Once host publishes code, all clients load it by performing document.write(code).
- The code should handle real-time updates and allow rejoining after page reload.

Write a complete HTML/JS implementation following these rules.
      `.trim();
      debug("Copie du prompt LLM dans le presse-papier");
      navigator.clipboard.writeText(prompt).then(() => alert("LLM prompt copied!"));
    };

    // --- Fonction pour remplacer le document par le code du jeu ---
    function launchGame(code) {
      debug("launchGame() : écriture du code avec document.write()");
      document.open();
      document.write(code);
      document.close();
    }

    // --- Initialisation au chargement de la page ---
    window.onload = () => {
      console.log("window.onload : lecture de l’URL et des cookies");

      // 1) Pré-remplir playerName si fourni en URL ou cookie
      const nameParam = urlParams.get("name");
      if (nameParam) {
        playerName = nameParam;
        debug(`playerName initialisé depuis URL: "${playerName}"`);
        setCookie("name", playerName);
        document.getElementById("playerName").value = playerName;
        // On ne cache pas encore “Enter Name” car on doit d’abord masquer via code :
        enterNameContainer.classList.add("hidden");
        showJoinCreate();
      } else {
        const fromCookie = getCookie("name");
        if (fromCookie) {
          playerName = fromCookie;
          debug(`playerName initialisé depuis cookie: "${playerName}"`);
          document.getElementById("playerName").value = playerName;
        }
      }

      // 2) Si gameId + playerName dispo, call addPlayer()/showLobby()
      if (gameId && playerName) {
        debug(`Onglet chargé avec gameId="${gameId}" et playerName="${playerName}", on auto‐ajoute et showLobby()`);
        enterNameContainer.classList.add("hidden");
        joinCreateContainer.classList.add("hidden");
        tokenContainer.classList.add("hidden");
        addPlayer();
        showLobby();
      }
    };

    // --- Gestion du bouton “Save Name” ---
    document.getElementById("saveNameBtn").onclick = () => {
      const nameVal = document.getElementById("playerName").value.trim();
      if (!nameVal) {
        alert("Please enter your name.");
        return;
      }
      playerName = nameVal;
      debug(`playerName sauvegardé: "${playerName}"`);
      setCookie("name", playerName);
      updateURL({ name: playerName });
      enterNameContainer.classList.add("hidden");
      showJoinCreate();
    };
  </script>
</body>
</html>
