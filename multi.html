<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multiplayer HTML Game</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-bottom: 20px;
    }
    input[type="text"], input[type="password"], textarea, button {
      width: 100%;
      max-width: 400px;
      margin: 5px 0;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .hidden {
      display: none;
    }
    #playersList {
      margin: 10px 0;
      width: 100%;
      max-width: 400px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
    }
    #playersList p {
      margin: 5px 0;
    }
    #chatBox {
      width: 100%;
      max-width: 400px;
      height: 150px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 5px;
    }
    #joinCreateContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 400px;
    }
  </style>
</head>
<body>
  <h1>Multiplayer HTML Game</h1>

  <!-- 1: Enter Name -->
  <div id="enterNameContainer">
    <input type="text" id="playerName" placeholder="Your Name" />
    <button id="saveNameBtn">Save Name</button>
  </div>

  <!-- 2: Join or Create Game -->
  <div id="joinCreateContainer" class="hidden">
    <input type="text" id="gameIdInput" placeholder="Enter Game ID to join" maxlength="8" />
    <button id="joinCreateBtn">Create Game</button>
  </div>

  <!-- 3: Creator token prompt (if needed) -->
  <div id="tokenContainer" class="hidden">
    <input type="password" id="creatorTokenInput" placeholder="Enter Creator Token" />
    <button id="saveTokenBtn">Save Token</button>
  </div>

  <!-- 4: Game Lobby -->
  <div id="lobbyContainer" class="hidden">
    <p><strong>Game ID:</strong> <span id="gameIdDisplay"></span>
      <button id="copyLinkBtn">Copy Link</button>
      <span id="copyNotice" style="color:green"></span>
    </p>
    <div id="playersList"><h3>Players:</h3></div>
    <div id="chatBox"></div>
    <input type="text" id="chatInput" placeholder="Type your message..." />

    <!-- Host only -->
    <div id="hostOptions" class="hidden">
      <textarea id="codeEditor" placeholder="Paste HTML/JS game code here..."></textarea>
      <button id="testGameBtn">Test Game</button>
      <button id="launchGameBtn">Launch Game</button>
      <button id="copyLLMBtn">Copy LLM Info</button>
    </div>

    <p id="waitingMsg" class="hidden">Waiting for the host to start the game...</p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // --- Config Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAAcMZ-dvevYe7IuPSkkdW1ZITQJo8vHqY",
      authDomain: "htmls-f4326.firebaseapp.com",
      databaseURL: "https://htmls-f4326-default-rtdb.firebaseio.com",
      projectId: "htmls-f4326",
      storageBucket: "htmls-f4326.appspot.com",
      messagingSenderId: "1091418638117",
      appId: "1:1091418638117:web:22a03ada0c812b82177ccc",
      measurementId: "G-NF8DJEP777"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Utility functions ---
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }
    function setCookie(name, value) {
      document.cookie = `${name}=${value}; path=/`;
    }
    function generateGameId() {
      const chars = "ABCDEFGHJKLMNPRSTUVWXYZ23456789";
      let id = "";
      for (let i = 0; i < 8; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return id;
    }
    function updateURL(params) {
      const url = new URL(location.href);
      Object.keys(params).forEach(key => {
        if (params[key] !== null) url.searchParams.set(key, params[key]);
        else url.searchParams.delete(key);
      });
      history.replaceState(null, "", url.toString());
    }

    // --- DOM Elements ---
    const enterNameContainer = document.getElementById("enterNameContainer");
    const playerNameInput = document.getElementById("playerName");
    const saveNameBtn = document.getElementById("saveNameBtn");

    const joinCreateContainer = document.getElementById("joinCreateContainer");
    const gameIdInput = document.getElementById("gameIdInput");
    const joinCreateBtn = document.getElementById("joinCreateBtn");

    const tokenContainer = document.getElementById("tokenContainer");
    const creatorTokenInput = document.getElementById("creatorTokenInput");
    const saveTokenBtn = document.getElementById("saveTokenBtn");

    const lobbyContainer = document.getElementById("lobbyContainer");
    const gameIdDisplay = document.getElementById("gameIdDisplay");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const copyNotice = document.getElementById("copyNotice");
    const playersList = document.getElementById("playersList");
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const hostOptions = document.getElementById("hostOptions");
    const codeEditor = document.getElementById("codeEditor");
    const testGameBtn = document.getElementById("testGameBtn");
    const launchGameBtn = document.getElementById("launchGameBtn");
    const copyLLMBtn = document.getElementById("copyLLMBtn");
    const waitingMsg = document.getElementById("waitingMsg");

    // --- State ---
    const urlParams = new URLSearchParams(location.search);
    let playerName = null;
    let gameId = urlParams.get("game") || null;
    let creatorToken = urlParams.get("token") || getCookie("token");
    let isHost = false;

    // --- Step 1: Enter Name ---
    saveNameBtn.onclick = () => {
      const nameVal = playerNameInput.value.trim();
      if (!nameVal) return alert("Please enter your name.");
      playerName = nameVal;
      setCookie("name", playerName);
      updateURL({ name: playerName });
      enterNameContainer.classList.add("hidden");
      showJoinCreate();
    };

    // Prefill if name exists
    const nameParam = urlParams.get("name");
    if (nameParam) {
      playerName = nameParam;
      setCookie("name", playerName);
      enterNameContainer.classList.add("hidden");
      showJoinCreate();
    } else if (getCookie("name")) {
      playerName = getCookie("name");
      playerNameInput.value = playerName;
    }

    // --- Step 2: Join or Create Game ---
    function showJoinCreate() {
      joinCreateContainer.classList.remove("hidden");
      gameIdInput.addEventListener("input", () => {
        joinCreateBtn.textContent = gameIdInput.value.trim() ? "Join Game" : "Create Game";
      });
      joinCreateBtn.onclick = () => {
        const enteredId = gameIdInput.value.trim().toUpperCase();
        if (enteredId) {
          // Join existing
          gameId = enteredId;
          updateURL({ game: gameId });
          joinCreateContainer.classList.add("hidden");
          showLobby();
        } else {
          // Create new
          showTokenPrompt();
        }
      };
    }

    // --- Token prompt for host ---
    function showTokenPrompt() {
      tokenContainer.classList.remove("hidden");
      saveTokenBtn.onclick = () => {
        const tokenVal = creatorTokenInput.value.trim();
        if (!tokenVal) return alert("Please enter a token.");
        creatorToken = tokenVal;
        setCookie("token", creatorToken);
        gameId = generateGameId();
        updateURL({ token: creatorToken, game: gameId });
        tokenContainer.classList.add("hidden");
        joinCreateContainer.classList.add("hidden");
        isHost = true;
        showLobby();
      };
    }

    // If token in URL or cookie, set host flag
    if (creatorToken) {
      isHost = true;
      setCookie("token", creatorToken);
    }

    // --- Step 3: Lobby ---
    function showLobby() {
      lobbyContainer.classList.remove("hidden");
      gameIdDisplay.textContent = gameId;
      copyLinkBtn.onclick = () => {
        const link = `${location.origin}${location.pathname}?game=${gameId}&name=${playerName}`;
        navigator.clipboard.writeText(link).then(() => {
          copyNotice.textContent = "Link copied!";
          setTimeout(() => (copyNotice.textContent = ""), 2000);
        });
      };

      // Players list
      const playersRef = db.ref(`games/${gameId}/players`);
      playersRef.child(playerName).set(playerName);
      playersRef.child(playerName).onDisconnect().remove();
      playersRef.on("value", (snap) => {
        const val = snap.val() || {};
        playersList.innerHTML =
          "<h3>Players:</h3>" +
          Object.values(val)
            .map((p) => `<p>${p}</p>`)
            .join("");
      });

      // Chat
      const chatRef = db.ref(`games/${gameId}/chat`);
      chatRef.on("child_added", (snap) => {
        const { name, text } = snap.val();
        const p = document.createElement("p");
        p.innerHTML = `<strong>${name}:</strong> ${text}`;
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && chatInput.value.trim()) {
          e.preventDefault();
          chatRef.push({ name: playerName, text: chatInput.value.trim() });
          chatInput.value = "";
        }
      });

      // Host options
      if (isHost) {
        hostOptions.classList.remove("hidden");
        waitingMsg.classList.add("hidden");
      } else {
        waitingMsg.classList.remove("hidden");
        // Listen for code
        const codeRef = db.ref(`games/${gameId}/code`);
        codeRef.on("value", (snap) => {
          if (snap.exists()) {
            waitingMsg.classList.add("hidden");
            const code = snap.val();
            launchGame(code);
          }
        });
      }
    }

    // Test and launch code
    testGameBtn.onclick = () => launchGame(codeEditor.value);
    launchGameBtn.onclick = () => db.ref(`games/${gameId}/code`).set(codeEditor.value);

    // Copy LLM Info button functionality
    copyLLMBtn.onclick = () => {
      const prompt = `
You are building a multiplayer browser game in a single HTML file.

Requirements:
- Each player has a unique name passed via URL parameter 'name'.
- The game room is identified by 'game' parameter in the URL.
- The host passes a 'token' parameter in the URL to create the room.
- Use Firebase Realtime Database at path 'games/${gameId}' to synchronize:
  - players list at '/players'
  - chat at '/chat'
  - game code at '/code'
- Once host publishes code, all clients load it by performing document.write(code).
- The code should handle real-time updates and allow rejoining after page reload.

Write a complete HTML/JS implementation following these rules.
      `.trim();
      navigator.clipboard.writeText(prompt).then(() => alert("LLM prompt copied!"));
    };

    // Launch game via document.write
    function launchGame(code) {
      // Replace entire document with the game code
      document.open();
      document.write(code);
      document.close();
    }

    // Initial load logic
    window.onload = () => {
      const nameFromCookie = getCookie("name");
      if (nameFromCookie) {
        playerNameInput.value = nameFromCookie;
      }
      if (gameId && playerName) {
        enterNameContainer.classList.add("hidden");
        showLobby();
      }
    };
  </script>
</body>
</html>
