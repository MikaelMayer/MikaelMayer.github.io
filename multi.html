<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multiplayer Code Editor</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f9f9f9;
    }
    textarea {
      width: 90%;
      height: 200px;
      font-family: monospace;
      font-size: 14px;
      margin: 10px 0;
    }
    #chat {
      width: 90%;
      height: 100px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      background: white;
      margin-bottom: 10px;
      padding: 5px;
    }
    #messages {
      list-style: none;
      padding: 0;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 14px;
    }
    #tokenRequest {
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Multiplayer Code Editor</h1>  <div id="tokenRequest">
    <p>Enter creator token to create a new game:</p>
    <input type="password" id="creatorTokenInput" placeholder="Creator token" />
    <button onclick="useCreatorToken()">Use Token</button>
  </div>  <div id="joinSection" style="display: none;">
    <input type="text" id="playerName" placeholder="Your name" />
    <button onclick="joinGame()">Join Game</button>
  </div>  <div id="mainSection" style="display: none;">
    <h2>Chat</h2>
    <div id="chat"><ul id="messages"></ul></div>
    <input type="text" id="chatInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button><h2>Code (Host only)</h2>
<textarea id="codeEditor"></textarea>
<button onclick="updateCode()">Share Code</button>

  </div>  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('game');
    const creatorTokenFromUrl = urlParams.get('token');
    const databaseUrl = 'https://anecdotesfamiliales-default-rtdb.firebaseio.com';
    let playerName = '';
    let isHost = false;
    let gameCode = '';

    function show(el) { el.style.display = 'block'; }
    function hide(el) { el.style.display = 'none'; }

    const tokenRequestDiv = document.getElementById('tokenRequest');
    const joinSection = document.getElementById('joinSection');
    const mainSection = document.getElementById('mainSection');

    if (!gameId && !creatorTokenFromUrl) {
      show(tokenRequestDiv);
    } else if (creatorTokenFromUrl) {
      createGameWithToken(creatorTokenFromUrl);
    } else {
      show(joinSection);
    }

    function useCreatorToken() {
      const token = document.getElementById('creatorTokenInput').value;
      if (!token) return alert("Please enter a token");
      const newUrl = `${location.origin}${location.pathname}?token=${encodeURIComponent(token)}`;
      location.href = newUrl;
    }

    async function createGameWithToken(token) {
      const id = 'game-' + Math.random().toString(36).substring(2, 8);
      const res = await fetch(`${databaseUrl}/games/${id}.json?auth=${token}`, {
        method: 'PUT',
        body: JSON.stringify({ createdAt: Date.now(), code: '', messages: [] })
      });
      if (res.ok) {
        window.location.href = `${location.pathname}?game=${id}`;
      } else {
        alert("Failed to create game. Invalid token?");
      }
    }

    async function joinGame() {
      playerName = document.getElementById('playerName').value.trim();
      if (!playerName) return alert("Enter your name");
      show(mainSection);
      hide(joinSection);
      startListening();
    }

    function sendMessage() {
      const msg = document.getElementById('chatInput').value.trim();
      if (!msg || !playerName) return;
      const data = { name: playerName, msg, time: Date.now() };
      fetch(`${databaseUrl}/games/${gameId}/messages.json`, {
        method: 'POST',
        body: JSON.stringify(data)
      });
      document.getElementById('chatInput').value = '';
    }

    function updateCode() {
      const code = document.getElementById('codeEditor').value;
      fetch(`${databaseUrl}/games/${gameId}/code.json`, {
        method: 'PUT',
        body: JSON.stringify(code)
      });
    }

    async function startListening() {
      const messagesList = document.getElementById('messages');
      const codeEditor = document.getElementById('codeEditor');

      setInterval(async () => {
        const res = await fetch(`${databaseUrl}/games/${gameId}.json`);
        const data = await res.json();

        if (Array.isArray(data?.messages)) {
          messagesList.innerHTML = '';
          data.messages.forEach(msg => {
            const li = document.createElement('li');
            li.textContent = `${msg.name}: ${msg.msg}`;
            messagesList.appendChild(li);
          });
        } else {
          const list = [];
          for (const key in data?.messages) {
            list.push(data.messages[key]);
          }
          list.sort((a,b)=>a.time-b.time);
          messagesList.innerHTML = '';
          list.forEach(msg => {
            const li = document.createElement('li');
            li.textContent = `${msg.name}: ${msg.msg}`;
            messagesList.appendChild(li);
          });
        }

        codeEditor.value = data.code || '';
      }, 1000);
    }
  </script></body>
</html>
